import asyncio
import logging
import os
import requests
import re
from datetime import datetime, timedelta, timezone
from aiogram import Bot, Dispatcher, Router
from aiogram.types import Message, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.filters import Command
from aiogram.utils.keyboard import InlineKeyboardBuilder

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞!")

STREAM_URL = "https://www.twitch.tv/silovik_"
CHANNEL_URL = "https://t.me/silovik_stream"
SUPPORT_URL = "https://dalink.to/silovik_"

# === –ü–ï–†–ï–í–û–î–´ ===
EVENTS_RU = {
    "Lush Blooms": "–ü—ã—à–Ω–æ–µ –¶–≤–µ—Ç–µ–Ω–∏–µ",
    "Matriarch": "–ú–∞—Ç—Ä–∏–∞—Ä—Ö",
    "Night Raid": "–ù–æ—á–Ω–æ–π –ù–∞–ª—ë—Ç",
    "Uncovered Caches": "–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –¢–∞–π–Ω–∏–∫–∏",
    "Electromagnetic Storm": "–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –ë—É—Ä—è",
    "Harvester": "–ñ–Ω–µ—Ü",
    "Husk Graveyard": "–ö–ª–∞–¥–±–∏—â–µ –•–∞—Å–∫–æ–≤",
    "Launch Tower Loot": "–î–æ–±—ã—á–∞ —Å –ü—É—Å–∫–æ–≤–æ–π –ë–∞—à–Ω–∏",
    "Prospecting Probes": "–†–∞–∑–≤–µ–¥—ã–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ó–æ–Ω–¥—ã",
}

MAPS_RU = {
    "Blue Gate": "–°–∏–Ω–∏–µ –í—Ä–∞—Ç–∞",
    "Dam": "–ü–ª–æ—Ç–∏–Ω–∞",
    "Spaceport": "–ö–æ—Å–º–æ–ø–æ—Ä—Ç",
    "Buried City": "–ü–æ–≥—Ä–µ–±—ë–Ω–Ω—ã–π –ì–æ—Ä–æ–¥",
    "Stella Montis": "–°—Ç–µ–ª–ª–∞ –ú–æ–Ω—Ç–∏c",
}

def tr_event(name): return EVENTS_RU.get(name, name)
def tr_map(name): return MAPS_RU.get(name, name)

# === –ü–ê–†–°–ò–ù–ì –° –°–ê–ô–¢–ê ARCRaidersHub ===
def fetch_events_from_hub():
    headers = {"User-Agent": "Mozilla/5.0 (compatible; Telegram Bot)"}
    resp = requests.get("https://arcraidershub.com/events", headers=headers, timeout=10)
    resp.raise_for_status()
    html = resp.text

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ HTML
    events = []
    # –ü—Ä–∏–º–µ—Ä: <span class="event-name">Harvester</span> <span class="event-map">Dam</span> <span class="event-time">19:00‚Äì20:00</span>
    pattern = r'<span class="event-name">([^<]+)</span>.*?<span class="event-map">([^<]+)</span>.*?<span class="event-time">(\d{2}):\d{2}‚Äì(\d{2}):\d{2}</span>'
    matches = re.findall(pattern, html, re.DOTALL)

    for name, loc, start_h, end_h in matches:
        start_hour = int(start_h)
        end_hour = int(end_h)
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –∫–∞–∂–¥—ã–π —á–∞—Å, –≤ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–æ –∏–¥—ë—Ç
        for hour in range(start_hour, end_hour):
            events.append({
                'name': name.strip(),
                'location': loc.strip(),
                'start_hour': hour,
                'end_hour': (hour + 1) % 24
            })

    return events

def get_current_events():
    # –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+3)
    now = datetime.now(timezone(timedelta(hours=3)))
    current_hour = now.hour
    minutes = now.minute
    seconds = now.second
    total_sec = minutes * 60 + seconds

    events = fetch_events_from_hub()
    active = []
    upcoming = []

    # === –ê–ö–¢–ò–í–ù–´–ï –°–û–ë–´–¢–ò–Ø ===
    for ev in events:
        if ev['start_hour'] == current_hour and total_sec < 3600:
            time_left = 3600 - total_sec
            mins, secs = divmod(time_left, 60)
            active.append({
                'name': ev['name'],
                'location': ev['location'],
                'info': f"–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ {int(mins)}m {int(secs)}s",
                'time': f"({ev['start_hour']}:00‚Äì{ev['end_hour']}:00 –ú–°–ö)"
            })

    # === –ü–†–ï–î–°–¢–û–Ø–©–ò–ï –°–û–ë–´–¢–ò–Ø ===
    next_hour = (current_hour + 1) % 24
    for ev in events:
        if ev['start_hour'] == next_hour:
            time_until = 3600 - total_sec
            mins, secs = divmod(time_until, 60)
            upcoming.append({
                'name': ev['name'],
                'location': ev['location'],
                'info': f"–ù–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑ {int(mins)}m {int(secs)}s",
                'time': f"({next_hour}:00‚Äì{next_hour + 1}:00 –ú–°–ö)"
            })

    return active, upcoming

# === TELEGRAM ===
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

@router.message(Command("start"))
async def start_handler(message: Message):
    kb = InlineKeyboardBuilder()
    kb.button(text="üìÖ –°–æ–±—ã—Ç–∏—è", callback_data="events")
    kb.button(text="üì∫ –ú–æ–π —Å—Ç—Ä–∏–º", url=STREAM_URL)
    kb.button(text="üì¢ –ú–æ–π –∫–∞–Ω–∞–ª", url=CHANNEL_URL)
    kb.button(text="üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=SUPPORT_URL)
    kb.adjust(2)
    await message.answer("üéÆ ARC Raiders: —Å–æ–±—ã—Ç–∏—è (–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —Å arcraidershub.com)", reply_markup=kb.as_markup())

@router.callback_query(lambda c: c.data == "events")
async def events_handler(callback: CallbackQuery):
    await callback.answer()
    try:
        active, upcoming = get_current_events()
    except Exception as e:
        await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return

    if not active and not upcoming:
        msg = " august –ù–µ—Ç —Å–æ–±—ã—Ç–∏–π."
    else:
        parts = ["üéÆ <b>ARC Raiders: –°–æ–±—ã—Ç–∏—è</b> (–≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ, UTC+3)\n"]
        if active:
            parts.append("üü¢ <b>–°–µ–π—á–∞—Å:</b>")
            for e in active:
                parts.append(f" ‚Ä¢ <b>{tr_event(e['name'])}</b> ({tr_map(e['location'])}) ‚Äî {e['info']} {e['time']}")
        if upcoming:
            parts.append("\n‚è≥ <b>–°–∫–æ—Ä–æ:</b>")
            for e in upcoming[:30]:
                parts.append(f" ‚Ä¢ <b>{tr_event(e['name'])}</b> ({tr_map(e['location'])}) ‚Äî {e['info']} {e['time']}")

        msg = "\n".join(parts)
        if len(msg) > 4000:
            msg = msg[:3990] + "\n\n... (—Å–ø–∏—Å–æ–∫ —É—Å–µ—á—ë–Ω)"

    kb = InlineKeyboardBuilder()
    kb.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="events")
    kb.button(text="üì∫ –°—Ç—Ä–∏–º", url=STREAM_URL)
    kb.button(text="üì¢ –ö–∞–Ω–∞–ª", url=CHANNEL_URL)
    kb.button(text="üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=SUPPORT_URL)
    kb.adjust(2)

    current_text = callback.message.text or ""
    current_markup = callback.message.reply_markup
    new_markup = kb.as_markup()
    if current_text != msg or current_markup != new_markup:
        try:
            await callback.message.edit_text(msg, parse_mode="HTML", reply_markup=new_markup)
        except:
            await callback.message.answer(msg, parse_mode="HTML", reply_markup=new_markup)
    else:
        await callback.answer("–î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.")

dp.include_router(router)

async def main():
    logging.basicConfig(level=logging.INFO)
    print("‚úÖ ARC Raiders Telegram-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–∏–∑ arcraidershub.com)")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())